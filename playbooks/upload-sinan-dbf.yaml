---
- name: Upload SINAN DBF into Production
  hosts: cluster
  gather_facts: true

  vars:
    DBF_NAME: "{{ file }}"
    YEAR: "{{ year }}"
    CID: "{{ cid }}"
    HOST_DIR: ../ansible/roles/sinan/dbf
    HOST_DBF_PATH: "{{ HOST_DIR }}/{{ DBF_NAME }}.dbf"
    REMOTE_TARGET_DIR: /Storage/infodengue_data/sftp2/alertadengue/uploaded
    LOG_PATH: /var/log/ansible

  tasks:
    - name: Checking if ssh is running on port {{ cluster_node_port }}
      delegate_to: localhost
      wait_for:
        port: "{{ cluster_node_port }}"
        host: "{{ ansible_host }}"
        timeout: 10
      ignore_errors: true
      register: desired_port_check

    - name: Copying DBF to Production
      copy:
        src: "{{ HOST_DBF_PATH }}"
        dest: "{{ REMOTE_TARGET_DIR }}/{{ DBF_NAME }}.dbf"
        owner: "{{ cluster_user_name }}"
        group: "{{ cluster_user_name }}"

    - name: Registering sent DBF on log file
      shell: echo "{{ lookup('pipe','date') }} ==> DBF {{ DBF_NAME }} for cid {{ CID }} and year {{ YEAR }} uploaded successfully" >> {{ LOG_PATH }}/upload_sinan_dbf.log 2>&1
